# FMS Guardrails Orchestrator Performance Test

## Overview
A simple utility to easily set up an environment and run performance tests on the FMS Guardrails Orchestrator.
It will set up a namespace with an LLM (KServeRaw+vLLM), N copies of the same detector model, the GuardrailsOrchestrator, run a load testing scenario using [Goose ðŸª¿](https://book.goose.rs/) (which can easily be used generate a report in different formats). 

---

## Running Performance Tests

### Prerequisites
- An OpenShift cluster with at least a GPU node
- OpenShift AI operator (2.25 or later) plus all the required operators (Authorino, Serverless, Service Mesh, NFD, Nvidia GPU)
- KServeRaw deployment mode ([ðŸ“– Reference](https://access.redhat.com/solutions/7078183))
- TrustyAI component enabled
- Rust installed in the machine that will run the tests against the cluster ([ðŸ“– Reference](https://www.rust-lang.org/tools/install))

### Running the Tests

This repo has two main components:

1. **Setup Script**: [`setup.sh`](./setup.sh) - Easily deploy an LLM (Qwen2.5-0.5B-Instruct through KServeRaw+vLLM), an arbitrary number of copies of a given detector model, and a configured GuardrailsOrchestrator (with gateway)

2. **Load Testing Utility**: A utility for running load test scenarios and generating reports, based on [Goose ðŸª¿](https://book.goose.rs/)

#### Step-by-Step Instructions

**1. Run the setup script** ([`setup.sh`](./setup.sh)):

   - **Default configuration** (3 instances of the jailbreak detector):
     ```bash
     ./setup.sh
     ```

   - **Custom parameters**:
     ```bash
     ./setup.sh --num-detectors 2 \
                 --detector-name "ibm-hate-and-profanity-detector" \
                 --model-path "granite-guardian-hap-38m" \
                 --download-model "ibm-granite/granite-guardian-hap-38m"
     ```

   - **Help and usage details**:
     ```bash
     ./setup.sh --help
     ```

**2. Run the GooseAttack** (load testing scenario):

   - **Baseline scenario** (model without guardrails):
     ```bash
     SCENARIO="baseline" TOKEN=$(oc whoami -t) \
     cargo run --release -- \
       --host $HOST \
       --report-file=report.html \
       --no-reset-metrics \
       --run-time 1m
     ```

   - **FMS Guardrails Orchestrator scenario**:
     ```bash
     SCENARIO="guardrails" TOKEN=$(oc whoami -t) \
     cargo run --release -- \
       --host $HOST \
       --report-file=report.html \
       --no-reset-metrics \
       --run-time 1m
     ```

   > **Note**: `$HOST` is the ISVC Route OR the GuardrailsOrchestrator gateway Route, respectively.

**Additional Configuration**: Take a look at [Goose's runtime options](https://book.goose.rs/getting-started/runtime-options.html) and experiment with them by changing the arguments in the `cargo run` command.

---

### Results

You can explore three sample HTML reports generated by Goose in the [`report-examples/`](./report-examples) directory:

- [`report_baseline.html`](./report-examples/report_baseline.html) - Baseline performance (no guardrails)
- [`report_single_detector.html`](./report-examples/report_single_detector.html) - Single detector performance
- [`report_three_detectors.html`](./report-examples/report_three_detectors.html) - Three detectors performance
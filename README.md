# FMS Guardrails Orchestrator Performance Test

## Overview
A simple utility to easily set up an environment and run performance tests on the FMS Guardrails Orchestrator.

## Running performance tests
### Prerequisites
- An OpenShift cluster with at least a GPU node.
- OpenShift AI operator (2.25 or later) plus all the required operators (Authorino, Serverless, Service Mesh, NFD, Nvidia GPU).
- KServeRaw deployment mode ([Reference](https://access.redhat.com/solutions/7078183)).
- TrustyAI component enabled.
- Rust installed in the machine that will run the tests agains the cluster ([Reference](https://www.rust-lang.org/tools/install)).

### Running the tests
This repo has two main components:
- A bash script to easily deploy an LLM (Qwen2.5-0.5B-Instruct through KServeRaw+vLLM), an arbitrary number of copies of a given detector model, and a configured GuardrailsOrchestrator (with gateway).
- A utility for running load test scenarios and generating reports, based on [Goose](https://book.goose.rs/).

In order to run the tests:
1. Run the `setup.sh` script:
   1. Use all defaults (3 instances of the jailbreak detector): `./setup.sh` 
   2. Custom parameters: `./setup.sh --num-detectors 2 --detector-name "ibm-hate-and-profanity-detector" --model-path "granite-guardian-hap-38m" --download-model "ibm-granite/granite-guardian-hap-38m"`
   3. Check the usage for more details: `./setup.sh --help`

2. Run the GooseAttack (i.e. the load testing scenario) passing the necessary arguments and environmental variables:
   1. In order to test the baseline scenario (model without guardrails) use `SCENARIO="baseline"`: `SCENARIO="baseline" TOKEN=$(oc whoami -t) cargo run --release -- --host $HOST --report-file=report.html --no-reset-metrics --run-time 1m`
   2. In order to test the FMS Guardrails Orchestrator use `SCENARIO="guardrails"`: `SCENARIO="guardrails" TOKEN=$(oc whoami -t) cargo run --release -- --host $HOST --report-file=report.html --no-reset-metrics --run-time 1m`

Where `$HOST` is the ISVC Route OR the GuardrailsOrchestrator gateway Route, respectively.

Take a look at [Goose's runtime options](https://book.goose.rs/getting-started/runtime-options.html) and experiment with them by changing the arguments in the `cargo run` command.

### Results
You can take a look at three sample html reports generated by Goose at [report-examples](./report-examples)